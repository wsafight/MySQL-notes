<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>设置优化 | MySQL 笔记</title><meta name="description" content="记录使用 Mysql 数据库"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/MySQL-notes/assets/js/runtime~app.7a714f9a.js" as="script"><link rel="preload" href="/MySQL-notes/assets/css/styles.69ca16b2.css" as="style"><link rel="preload" href="/MySQL-notes/assets/js/640.685be32b.js" as="script"><link rel="preload" href="/MySQL-notes/assets/js/app.87610e08.js" as="script">
    <link rel="stylesheet" href="/MySQL-notes/assets/css/styles.69ca16b2.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/MySQL-notes/" class=""><!----><span class="site-name">MySQL 笔记</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/MySQL-notes/notes/" class="nav-link" aria-label="设计与使用"><!--[--><!--]--> 设计与使用 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/MySQL-notes/performance/" class="nav-link router-link-active" aria-label="分析与优化"><!--[--><!--]--> 分析与优化 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/MySQL-notes/error/" class="nav-link" aria-label="安全与错误"><!--[--><!--]--> 安全与错误 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/MySQL-notes/performance/config.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/MySQL-notes/en/" class="nav-link" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/MySQL-notes/notes/" class="nav-link" aria-label="设计与使用"><!--[--><!--]--> 设计与使用 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/MySQL-notes/performance/" class="nav-link router-link-active" aria-label="分析与优化"><!--[--><!--]--> 分析与优化 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/MySQL-notes/error/" class="nav-link" aria-label="安全与错误"><!--[--><!--]--> 安全与错误 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/MySQL-notes/performance/config.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/MySQL-notes/en/" class="nav-link" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">分析与优化</p><ul class=""><li><!--[--><a href="/MySQL-notes/performance/explain.html" class="nav-link sidebar-item" aria-label="使用 EXPLAIN 来分析 SQL 查询问题"><!--[--><!--]--> 使用 EXPLAIN 来分析 SQL 查询问题 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/MySQL-notes/performance/database-index.html" class="nav-link sidebar-item" aria-label="索引优化"><!--[--><!--]--> 索引优化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/MySQL-notes/performance/profiling.html" class="nav-link sidebar-item" aria-label="profiling 分析慢 sql 语句"><!--[--><!--]--> profiling 分析慢 sql 语句 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL-notes/performance/config.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="设置优化"><!--[--><!--]--> 设置优化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/MySQL-notes/performance/soar.html" class="nav-link sidebar-item" aria-label="soar 分析并优化 SQL 语句"><!--[--><!--]--> soar 分析并优化 SQL 语句 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="设置优化" tabindex="-1"><a class="header-anchor" href="#设置优化" aria-hidden="true">#</a> 设置优化</h1><p>在服务器的BIOS设置中，可调整下面的几个配置，目的是发挥CPU最大性能，或者避免经典的NUMA问题：</p><p>1、选择Performance Per Watt Optimized(DAPC)模式，发挥CPU最大性能，跑DB这种通常需要高运算量的服务就不要考虑节电了；</p><p>2、关闭C1E和C States等选项，目的也是为了提升CPU效率；</p><p>3、Memory Frequency（内存频率）选择Maximum Performance（最佳性能）；</p><p>4、内存设置菜单中，启用Node Interleaving，避免NUMA问题；</p><p>下面几个是按照IOPS性能提升的幅度排序，对于磁盘I/O可优化的一些措施：</p><p>1、使用SSD或者PCIe SSD设备，至少获得数百倍甚至万倍的IOPS提升；</p><p>2、购置阵列卡同时配备CACHE及BBU模块，可明显提升IOPS（主要是指机械盘，SSD或PCIe SSD除外。同时需要定期检查CACHE及BBU模块的健康状况，确保意外时不至于丢失数据）；</p><p>3、有阵列卡时，设置阵列写策略为WB，甚至FORCE WB（若有双电保护，或对数据安全性要求不是特别高的话），严禁使用WT策略。并且闭阵列预读策略，基本上是鸡肋，用处不大；</p><p>4、尽可能选用RAID-10，而非RAID-5；</p><p>5、使用机械盘的话，尽可能选择高转速的，例如选用15KRPM，而不是7.2KRPM的盘，不差几个钱的；</p><p>在文件系统层，下面几个措施可明显提升IOPS性能：</p><p>1、使用deadline/noop这两种I/O调度器，千万别用cfq（它不适合跑DB类服务）；</p><p>2、使用xfs文件系统，千万别用ext3；ext4勉强可用，但业务量很大的话，则一定要用xfs；</p><p>3、文件系统mount参数中增加：noatime, nodiratime, nobarrier几个选项（nobarrier是xfs文件系统特有的）；</p><p>针对关键内核参数设定合适的值，目的是为了减少swap的倾向，并且让内存和磁盘I/O不会出现大幅波动，导致瞬间波峰负载：</p><p>1、将vm.swappiness设置为5-10左右即可，甚至设置为0（RHEL 7以上则慎重设置为0，除非你允许OOM kill发生），以降低使用SWAP的机会；</p><p>2、将vm.dirty_background_ratio设置为5-10，将vm.dirty_ratio设置为它的两倍左右，以确保能持续将脏数据刷新到磁盘，避免瞬间I/O写，产生严重等待（和MySQL中的innodb_max_dirty_pages_pct类似）；</p><p>3、将net.ipv4.tcp_tw_recycle、net.ipv4.tcp_tw_reuse都设置为1，减少TIME_WAIT，提高TCP效率；</p><p>4、至于网传的read_ahead_kb、nr_requests这两个参数，我经过测试后，发现对读写混合为主的OLTP环境影响并不大（应该是对读敏感的场景更有效果），不过没准是我测试方法有问题，可自行斟酌是否调整；</p><p>建议调整下面几个关键参数以获得较好的性能（可使用本站提供的my.cnf生成器生成配置文件模板）：</p><p>1、选择Percona或MariaDB版本的话，强烈建议启用thread pool特性，可使得在高并发的情况下，性能不会发生大幅下降。此外，还有extra_port功能，非常实用， 关键时刻能救命的。还有另外一个重要特色是 QUERY_RESPONSE_TIME 功能，也能使我们对整体的SQL响应时间分布有直观感受；</p><p>2、设置default-storage-engine=InnoDB，也就是默认采用InnoDB引擎，强烈建议不要再使用MyISAM引擎了，InnoDB引擎绝对可以满足99%以上的业务场景；</p><p>3、调整innodb_buffer_pool_size大小，如果是单实例且绝大多数是InnoDB引擎表的话，可考虑设置为物理内存的50% ~ 70%左右；</p><p>4、根据实际需要设置innodb_flush_log_at_trx_commit、sync_binlog的值。如果要求数据不能丢失，那么两个都设为1。如果允许丢失一点数据，则可分别设为2和10。而如果完全不用care数据是否丢失的话（例如在slave上，反正大不了重做一次），则可都设为0。这三种设置值导致数据库的性能受到影响程度分别是：高、中、低，也就是第一个会另数据库最慢，最后一个则相反；</p><p>5、设置innodb_file_per_table = 1，使用独立表空间，我实在是想不出来用共享表空间有什么好处了；</p><p>6、设置innodb_data_file_path = ibdata1:1G:autoextend，千万不要用默认的10M，否则在有高并发事务时，会受到不小的影响；</p><p>7、设置innodb_log_file_size=256M，设置innodb_log_files_in_group=2，基本可满足90%以上的场景；</p><p>8、设置long_query_time = 1，而在5.5版本以上，已经可以设置为小于1了，建议设置为0.05（50毫秒），记录那些执行较慢的SQL，用于后续的分析排查；</p><p>9、根据业务实际需要，适当调整max_connection（最大连接数）、max_connection_error（最大错误数，建议设置为10万以上，而open_files_limit、innodb_open_files、table_open_cache、table_definition_cache这几个参数则可设为约10倍于max_connection的大小；</p><p>10、常见的误区是把tmp_table_size和max_heap_table_size设置的比较大，曾经见过设置为1G的，这2个选项是每个连接会话都会分配的，因此不要设置过大，否则容易导致OOM发生；其他的一些连接会话级选项例如：sort_buffer_size、join_buffer_size、read_buffer_size、read_rnd_buffer_size等，也需要注意不能设置过大；</p><p>11、由于已经建议不再使用MyISAM引擎了，因此可以把key_buffer_size设置为32M左右，并且强烈建议关闭query cache功能；</p><p>关于MySQL的管理维护的其他建议有：</p><p>1、通常地，单表物理大小不超过10GB，单表行数不超过1亿条，行平均长度不超过8KB，如果机器性能足够，这些数据量MySQL是完全能处理的过来的，不用担心性能问题，这么建议主要是考虑ONLINE DDL的代价较高；</p><p>2、不用太担心mysqld进程占用太多内存，只要不发生OOM kill和用到大量的SWAP都还好；</p><p>3、在以往，单机上跑多实例的目的是能最大化利用计算资源，如果单实例已经能耗尽大部分计算资源的话，就没必要再跑多实例了；</p><p>4、定期使用pt-duplicate-key-checker检查并删除重复的索引。定期使用pt-index-usage工具检查并删除使用频率很低的索引；</p><p>5、定期采集slow query log，用pt-query-digest工具进行分析，可结合Anemometer系统进行slow query管理以便分析slow query并进行后续优化工作；</p><p>6、可使用pt-kill杀掉超长时间的SQL请求，Percona版本中有个选项 innodb_kill_idle_transaction也可实现该功能；</p><p>7、使用pt-online-schema-change来完成大表的ONLINE DDL需求；</p><p>8、定期使用pt-table-checksum、pt-table-sync来检查并修复mysql主从复制的数据差异；</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/7/27 下午6:13:36</span></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/MySQL-notes/performance/profiling.html" class="nav-link" aria-label="profiling 分析慢 sql 语句"><!--[--><!--]--> profiling 分析慢 sql 语句 <!--[--><!--]--></a></span><span class="next"><a href="/MySQL-notes/performance/soar.html" class="nav-link" aria-label="soar 分析并优化 SQL 语句"><!--[--><!--]--> soar 分析并优化 SQL 语句 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/MySQL-notes/assets/js/runtime~app.7a714f9a.js" defer></script><script src="/MySQL-notes/assets/js/640.685be32b.js" defer></script><script src="/MySQL-notes/assets/js/app.87610e08.js" defer></script>
  </body>
</html>
